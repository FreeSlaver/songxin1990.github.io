---
layout: page
title: 消息中心项目模拟面试
category: interview
categoryStr: 项目总结
tags:
keywords:
description:
---
## 画一下项目的整体架构图？

## 黑白名单怎么实现的？
黑白名单，主要分为ip黑白名单，设备id黑白名单等，主要在网关层实现，将对应的黑名单记录在数据库中，
系统启动时，会读取出来后加载到redis中，每次请求过来，判断ip，设备id是否在黑名单中，在，直接拦截，拒绝请求；
不在，放行。然后这里还有个问题是，临时的新增的黑名单，比如某个ip虽然不在黑白名单中，但是某个时刻，在一分钟内
发送了上百几千次请求，这种明显也是不正常的，会将它添加到黑名单中。

你摧毁老子，老子也能摧毁你，你逼死老子，老子也能逼死你。不要怨别人，就看谁的手段更狠更毒辣。
## 短信通道自动切换怎么做的？
首先要有一个标准判断这个短信通道故障了，比如发送同一条短信连续3次失败，这时可以判断是通道故障，但是更可能是网络抖动，
但是如果连续5条短信重试3次失败，那么可以肯定这条短信通道故障了，这时可以给这条通道设置一个标志位，表示故障，
可以用MySQL，或者Redis，但是这样每次发送前要判断明显不好。比较好的方案是：刚开始将所有可用的通道丢到一个集合中，
按某种属性排序，发现通道故障之后，从集合中剔除。
故障恢复：通道故障之后，肯定不会一直故障，恢复之后如何再次添加到可用通道集合中，同样也涉及到一个判断标准就是：
如何知道短信通道故障修复了？1.短信供应商告知，所以这里最后有个后台能手动将故障通道恢复；
2.系统最好有个自动检测机制能判断出通道已经恢复，比如在15分钟内，每隔3分钟向一个测试手机号发送测试短信，如果都正常，那么认为通道恢复，
将通道添加到可用通道集合中。
## 整体项目怎么部署的？

## 如何不依赖任何人，任何组织活下去？
这根本不可能，人和人之间是相互“需要”的，呵呵。失去一些东西，同时也能得到一些东西。
所有的新生，涅槃之前必须经历死亡。

## 高峰期最高QPS多少？

## 服务器配置多少？

## 想清楚整个消息中心怎么设计
首先让需要收发短信的业务模块去管理后台申请appkey，生成appsecret，然后调用的时候，生成签名，服务端接收到请求之后会对签名进行校验。
网关里面还有黑白名单，熔断限流等功能，
## 限流，熔断，降级


## 熔断限流怎么做的？
熔断限流分几个：一个是针对单个手机号，一般是半小时不超过发送10条；一个是针对业务，不同的业务设置的值不同；
还有一个是针对流量，就是请求发送短信的请求次数。
实现的话是通过redis中的计数器，草，这个要google一下，应该是通过zset，手机号为key，然后每次发送短信就添加一条数据，时间戳作为score，
然后熔断限流就是判断当前时间戳到半小时前的时间戳，这段时间内的总的数据条数，如果大于设定阈值，就直接拒绝。


## 定时批量发送短信怎么做的？
使用的分布式定时调度xxjob，

## 整个的数据流转，业务过程是怎样的？
同城系统调用发送短信，服务端进行签名验证，黑白名单验证，通过之后，生成验证码，设置验证码有效期，然后将手机号做key，验证码做value存放到redis中，
将验证码有效期设置为key的过期时间。然后调用三方短信渠道进行发送，不存数据库吗？直接从redis中读出哪个手机，发送什么短信内容？
存数据库，是不是要记录发送状态，待发送，已发送，已送达，发送失败，
问题：
### 1.这个存放redis和调用三方的先后顺序？不应该是等调用完成之后，获取到发送成功的回执后在存入redis？
先存验证码到redis中，如果短信发送失败了？是不是要删除redis？
如果等调用完成，获取到回执之后存redis，假设回执慢了十几秒，而用户已经受到验证码，但是你redis中没存入验证码，怎么弄？
后存redis，如果前面一个业务做完了，然后搞下一个业务，再发验证码，用户直接用原来的那个验证码，通过验证了，怎么办？

所以最好的情况是：调用三方接口之后，再将验证码放到redis中，但是依然有问题，1.回执显示发送失败，这时删除redis；
### 2.失败重试方案是怎么做的？？
这个失败重试要分几种情况，以发送短信举例，有验证码的，有营销的，有业务流程的。
比如发送验证码，调用第三方短信渠道，失败有可能是请求超时，也有可能是调用成功，但是查询回执失败。
如果是请求超时，因为验证码这种实时性要求比较高，所以最好的策略是直接更换渠道。
如果是营销类的，业务流程相关的，可以直接3次重试，全部失败的话，发送邮件告警，
后续的策略可以是换通道，也可以放到延时队列中后面进行重发，也可以保存到数据库中，进行定时调度重发。
我们这里使用的是延时队列，不过这个重发次数是有限制的，默认5次，每次失败后再次丢入延时队列，
5次全部失败后，记录到库，发送邮件告警。

### 4.消息中心怎么分布式部署的？
通过Nginx反向代理，round robin的方式，顺序分配到几个机器上。那如果其中一台机器挂掉了？
### 5.是直接同步调用三方渠道接口？

### 6.消息幂等性怎么保证的？怎么保证不重发，不漏发短信？
短信，消息推送这些偶尔的多发一次信息，并不影响整个的业务流程，对安全性，业务等也无甚影响，不像订单类的，支付类的，
和业务，金钱强关联的，有密切影响，所以需要消息幂等性。消息中心要保证消息幂等性这个只能保证从调用的请求方到调用第三方渠道之间的一致性，
而第三方渠道是否有重发，漏发，这个在系统之外无法保证。
使用的方法还是常规的，使用一个全局的发号器，生成唯一id，然后整个环节中都校验这个id是否重复。

## push服务是怎么实现的？？
使用拉的方式，但是如果系统现在刚发布一条营销通知，怎么弄？拉，是定时去拉，还是上线的时候拉？定时拉，浪费系统资源怎么弄？
推，用户，设备不在线，数据放哪里？？占用系统资源怎么弄？
拉和推能够结合吗？这就搞混了，没有分界线，不知道
使用推的方式实现，具体怎么做的？
1.全局营销，所有人


## 1.渠道的选择是如何设计的？就是一个消息中心，肯定是接入了多个短信渠道的，在发一条短信的时候，是如何确定选择那个渠道发送出去？
首先要考虑的是短信的投递场景，主要的有3种业务场景：验证码，业务通知，营销活动。
其中对验证码的实时性和抵达率有较高要求，而业务通知对实时性和抵达率要求较低，营销活动对实时性要求低，但是对抵达率较高。
再要考虑的就是短信的成本问题，一般实时性，抵达率高的渠道费用较高，所以就要将不同的短信渠道按照

为了确保系统的安全性，通常会设定验证码的时效性，并且只能使用一次，但是偶尔可能因为延时问题，引起用户多次申请验证码，基于缓存可以很好的管理这种场景的数据结构
## 2.被刷验证码接口，或者说被反复请求验证码，用户没收到验证码，点击重发是怎么处理的？

## 3.有人恶意拿大量手机号，然后点击获取验证码是怎么处理的？？

## 4.验证码怎么保证一定发送成功？重试机制是怎么样的？

## 5.一个手机号发验证码的上限有限制吗？

## 6.架构设计是怎么样的？用的哪些组件，怎么保证exactly once？

## 7.有人反复试验证码像试密码一样，你们怎么处理的？

## 8.网关是怎么设计，实现的？签名校验，权限校验，

-----------------------------
系统向APP推送的push怎么实现的？？？


