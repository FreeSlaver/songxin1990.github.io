---
layout: page
title: 货拉拉消息中心项目总结
category: project
categoryStr: 项目总结
tags:
keywords:
description:
---

## 3.1消息中心介绍
消息中心主要为HLL&LLM提供统一的消息服务，主要包括

- SMS：实现短信功能(业务通知短信、验证码短信等)
- Email：邮件服务（通知、行程单等）
- Push：实现所有应用系统向App的消息推送
同时，消息中心按开放平台的架构进行设计，各应用系统以open api的方式接入消息中心；提供消息中心管理平台（信鸽）用于应用接入管理、消息统计、报表查看、策略调整等功能。

##  3.2消息中心总体规划
消息中心服务规划如下：

序号	项目	主要功能	备注
1	短信服务	短信服务api、短信发送服务、短信回执服务、短信上行服务  
2	邮件服务	邮件服务api、邮件发送服务、附件上传服务  
3	Push服务	Push api网关、push service、回执上报、token上报  
4	信鸽平台	应用管理，系统配置，数据统计及报表	消息中心管理平台  
消息中心总体架构如下：


## 3.3 短信服务国际化
### 3.3.1 短信服务介绍
SMS 提供以下两种短信方式：

基于模板的通知类短信
基于内容的营销类短信
短信服务实现功能：

多通道冗余备份，故障自动转移，失败重试
黑白名单支持
支持短信上行
模板管理
批量短信任务（支持基于名单和基于大数据的画像）
支持频率控制，短信记录存储，数据报表统计
短信服务架构如下：


### 3.3.2 短服务国际化方案
#### 1.短信服务国际化主要解决以下问题

LLM 短信通道问题
手机号码国家码问题（当前HLL系统没有存储手机号码的国家码，在LLM中会存在问题）
#### 2.通道问题

短信服务规划之初，是按多通道来设计的。针对LLM的场景，我们是通过接入海外的短信服务商(Nexmo)来解决。

ChannelNexmoImpl就是本次国际化实现的，主要功能是接入海外的短信供应商Nexmo通道：


#### 3.国家码问题解决

前端将国家码、手机号，组装合并传递给接入层，接入层透传号码给短信服务，不改动号码格式
号码格式采用 e.164 标准，+[国家或地区码][手机号] ，示例如：+8618811112222， 其中前面有一个+号 ，86为国家码，18811112222为手机号，无缝组合。
e.164参考：https://zh.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E7%94%B5%E8%AF%9D%E5%8C%BA%E5%8F%B7%E5%88%97%E8%A1%A8

#### 4.短信校验

短信后台会调用libphonenumber包，校验国家码、手机号的合法性前端输入需要支持选择国家码，并且对手机号码进行弱校验   
#### 5.手机号码存储

使用一个字段存储手机号码（包括国家码以及手机号码）
需要检查数据库字段是否满足要求
需要检查判断手机号码格式的逻辑是否要调整  
## 3.4 Push服务国际化
### 3.4.1 Push服务介绍
Push 服务提供后台服务到手机App之间消息推送的功能。主要实现新订单信息推送，订单状态变更推送，优惠券推送，活动营销推送等功能。

目前主要有两种实现方式：

基于第三方推送供应商实现，自研的TCP长连接服务
接入手机厂商的push通道（APNs, 以及中国大陆android 厂商的push；LLM接入Google FCM）

### 3.4.2 Push服务国际化解决方案
Push服务国际化主要是解决通道问题
App端需要集成FCM的SDK
后端需要集成FCM服务端SDK
Push Token上报调整
App接入的Push SDK需要在手机设备上生成设备的唯一标识码，不同厂商的叫法不一样。我们可以通过这个设备唯一码给手机终端进行消息推送。业务方推送消息时，一般根据业务的ID来推送，push后台服务会维护push cid与业务id的关联关系。

App端解决方案
App端需要集成Google FCM的SDK，包括 ios,android版本。并且需要根据业务要求，实现通知栏弹出消息，或者程序内部处理通知。

服务端决方案
从Push服务的总体构架上我们可以看出，后端push服务设计之初，已经考虑了国内众多android厂商的push服务以及Apple APNs。我们当前就已经接入了华为、小米、OPPO、VIVO、APNs等厂商推送。因此，我们在LLM场景，支持Google FCM服务，也只需要在当前系统上进行一定的扩展就可以实现，具体以下两部分工作：

Token上报(内部也叫cid上报)
Token上报协议如下(部分字段未显示)：

请求参数：

参数名	必选	类型	说明
os	是	int	操作系统， 1 安卓 2 IOS
pushCid	否	string	各个厂商推送渠道的推送token
cidType	是	int	厂商token类型 3-apple 4-xiaomi 5-huawei 6-meizu 7-oppo 8-vivo 10-hw快应用 13-fcm通道上报的，为国际化项目增加部分
Push服务
Push服务类结构图如下：


从上图可以看出，push服务后端，目前已经实现了多个通道支持，本次主要实现FCM通道，通过FcmPushImpl类来完成对应功能，主要实现方法如下：


## 3.5 邮件服务国际化   
邮件服务使用统一的SMTP协议，实现与第三方邮件服务商的对接。实现邮件发送。由于邮件服务使用的SMTP是全球邮件的事实标准，因此，邮件服务在国际化接口及邮件发送服务不用做任何调整，就可以满足需求。
但邮件服务在国际化情况下，也存在一个问题：那就是邮件大附件的发送。目前在HLL场景下，我们是使用阿里去提供的OSS存储，来实现附件的临时存储。考虑到海外网络问题，我们系统是部署在AWS，如果此时附件使用OSS存储，则会导致邮件附件存储非常慢，因此，我们需要解决海外邮件附件存储问题。
因此，我们在LLM下，邮件附件存储服务通过接入S3的存储解决跨网络的附件存储问题。

## 4. 总结
   本次地图和消息的国际化，处于比较初始阶段，以满足功能业务功能需求为主；基于HLL原有系统架构基础上，快速的扩展接入第三方应用通道，完成国际化系统的落地。
后续，我们会基于同一套系统，针对全球化的业务场景，不断的迭代和优化。从通道冗余备份、熔断降级、数据深度挖掘融合、数据链路追踪等多方面提升消息和地图的国际化支撑能力。

## 5.具体实现
### 5.1 网关是怎么实现的，短信，Push，email是怎么转发请求的？
### 5.2 整个是以微服务的形式做服务治理还是单独的进行监控告警？
### 5.3 黑白名单怎么做的？权限校验怎么做的？
### 5.4 项目怎么部署的？每个服务几个实例？分布式，负载均衡怎么实现？
### 5.5 具体的QPS都是多少了？有优化吗？
### 5.6 遇到过什么难题吗？
### 5.7 画出项目整体架构图，请求业务流转图？
### 5.8 整个项目，架构你有发现哪些问题？或者说有哪些可以改进的地方了？

