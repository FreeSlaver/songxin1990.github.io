---
layout: page
title:  分布式配置
category: micro-service
tags:
keywords:
description:  
published:  true
---

分布式配置简单来说就是：将单体应用拆分成多个微服务，而且每个微服务为了实现高可用，至少都是双实例部署，  
所以如何将原来单体应用上的配置文件按照多个微服务进行拆分，并且保证每个微服务的配置都是统一的，实时的，并且最好能够一处更改，处处实时更新同步。  

你自己想一想要是你，会怎么实现？   

搞个后端控制管理台，然后相同微服务名对应一份配置。在后台更改配置，然后通知到微服务，每个微服务的实例自动拉取最新的配置，然后进行服务重启。    
当然配置能够热更新是最好的，好像也是有相应实现的。我记得我之前在公司就实现过配置热更新。  
这里有个问题是：更新一直失败怎么办？或者说某些微服务它的配置别人手动更改，和中心的配置不一致怎么办？

## 具体实现
### 1.中心配置存哪里？
- 存MySQL当然是比较容易方便的选择，但是单点故障单实例挂了怎么办？    
- 直接存本地文件系统，然后通过多实例冗余保证高可用性，缺点：性能有影响，多个文件副本保持一致也是个问题。   
- 直接存Redis缓存中，然后所有微服务实例，全部直接从里面拉取，优点：全局唯一，保证一致性，复杂度（高可用，一致性）留给Redis集群解决；缺点：三方依赖，紧耦合。  
### 2.配置热更新怎么实现？
配置文件热更新的原理是通过监听配置文件的变化，一旦配置文件发生修改，就重新加载配置文件，将新的配置参数应用到应用程序中，从而达到热更新的目的。

在Java中，可以使用java.nio.file包提供的WatchService来监听文件的变化。WatchService是一个监视文件系统中指定文件或目录变化的对象。当被监视的文件或目录发生变化时，WatchService会收到通知。

Nacos中
一：通过 @Value 注入后，结合注解 @RefreshScope 刷新配置。

过程是在要调用这些变化的配置的类中，通过注解 @Value 找到在 nacos 中配置的属性，然后在调用这些属性的类上加上注解 @RefreshScope 实现配置的自动更新。

二：通过 @ConfigurationProperties 注入配置，同时配合 @Component 将配置交给spring管理生效，自动刷新。

重新定义一个方法或者类(该注解使用于类和方法)，通过注解 @ConfigurationProperties 的属性 prefix 绑定配置文件中的配置，相当于捕捉到外部的配置信息，@Component 注解实现把配置交给 spring 管理，实现配置文件的自动刷新。

三.通过@NacosPropertySource和@ConfigurationProperties刷新配置文件内容。

### 3.某些微服务配置和中心配置不一致怎么发现，处理？
简单的来处理就是通过版本号来比对，但是如果版本号一致，但是具体配置中的某个属性不一致，怎么办？所以最好是通过配置文件的MD5比对。    
如何发现这种不一致？那就是配置中心起个定时任何，然后间隔一小时或多久去请求比对配置文件的MD5值。  

支持对配置的修改的检视以把控风险
可以查看配置修改的历史记录
不同部署环境下应用配置的隔离性
## 配置中心技术选型
目前市面流行的配置中心有：

Disconf
2014年7月，百度开源的配置管理中心，同样具备配置的管理能力，不过目前已经不维护了 。

Spring Cloud Config
2014年9月，Spring Cloud 开源生态组件，可以和Spring Cloud体系无缝整合，但依赖Git或SVN 。

Apollo
2016年5月，携程开源的配置管理中心，具备规范的权限、流程治理等特性。

Nacos
2018年6月，阿里开源的配置中心，也可以做RPC的服务发现。

因Disconf不再维护，且Spring Cloud Config 需要依赖Git或SVN。所以只介绍下Apollo和Nacos
### Nacos
Nacos 还提供包括配置版本跟踪、金丝雀发布、一键回滚配置以及客户端配置更新状态跟踪
Nacos使用简单、部署方便、性能较高，能够实现基本的配置管理，提供的控制台也非常简洁。

但权限方面控制粒度较粗，且没有审核机制。
### Apollo
Apollo(阿波罗)是携程框架部门研发的分布式配置中心，能够集中化管理应用的不同环境、不同集群的配置，配置修改后能够实时推送到应用端，  
并且具备规范的权限、流程治理等特性，适用于微服务配置管理场景。

目前提供了以下的特性：

统一管理不同环境、不同集群的配置  
配置修改实时生效(热发布)  
版本发布管理  
灰度发布  
权限管理、发布审核、操作审计  
客户端配置信息监控  
提供Java和.Net原生客户端  
提供开放平台API  
部署简单  

Config Service和Admin Service都是多实例、无状态部署，所以需要将自己注册到Eureka中并保持心跳
### 基于ZK来实现
这个的话就比较简单了，只需要在每个微服务实例配置一个Watcher监听ZK中存储配置的节点即可，每次微服务启动时去拉取一遍。   


















